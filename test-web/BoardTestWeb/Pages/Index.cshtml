@page
@model BoardTestWeb.Pages.IndexModel
@{
    ViewData["Title"] = "ê²Œì‹œíŒ ë¼ì´ë¸ŒëŸ¬ë¦¬ í…ŒìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ";
}

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .progress-card {
            transition: transform 0.2s;
        }
        .progress-card:hover {
            transform: translateY(-5px);
        }
        .status-badge {
            font-size: 0.75rem;
        }
        .test-item {
            border-left: 3px solid #dee2e6;
            padding-left: 15px;
            margin-bottom: 10px;
        }
        .test-item.passed {
            border-left-color: #198754;
        }
        .test-item.failed {
            border-left-color: #dc3545;
        }
        .test-item.pending {
            border-left-color: #ffc107;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">ğŸ“‹ ê²Œì‹œíŒ ë¼ì´ë¸ŒëŸ¬ë¦¬ í…ŒìŠ¤íŠ¸</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/swagger">Swagger API</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h4 class="card-title">ğŸ“Š ì „ì²´ í…ŒìŠ¤íŠ¸ ì§„í–‰ í˜„í™©</h4>
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="progress" style="height: 30px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 0%;" id="overallProgress">
                                        0%
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-primary" onclick="runAllTests()">
                                    â–¶ ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                                </button>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <small class="text-muted">ì „ì²´ í…ŒìŠ¤íŠ¸: <span id="totalTests">60</span>ê°œ</small>
                            </div>
                            <div class="col-md-4">
                                <small class="text-success">í†µê³¼: <span id="passedTests">0</span>ê°œ</small>
                            </div>
                            <div class="col-md-4">
                                <small class="text-danger">ì‹¤íŒ¨: <span id="failedTests">0</span>ê°œ</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- í˜ì´ì§€ 1: ê²Œì‹œë¬¼ ê´€ë¦¬ -->
            <div class="col-md-6 col-lg-3 mb-4">
                <div class="card progress-card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">ğŸ“ í˜ì´ì§€ 1</h5>
                        <small>ê²Œì‹œë¬¼ ê´€ë¦¬</small>
                    </div>
                    <div class="card-body">
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar" role="progressbar" style="width: 0%;" id="page1Progress">0%</div>
                        </div>
                        <p class="card-text small">
                            <strong>ì£¼ìš” ê¸°ëŠ¥:</strong><br>
                            â€¢ ê²Œì‹œë¬¼ CRUD<br>
                            â€¢ ì¡°íšŒìˆ˜ ê´€ë¦¬<br>
                            â€¢ ìƒë‹¨ê³ ì •<br>
                            â€¢ ì„ì‹œì €ì¥
                        </p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-secondary" id="page1Status">15ê°œ í…ŒìŠ¤íŠ¸</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="runPageTests(1)">í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
                        </div>
                    </div>
                    <div class="card-footer">
                        <a href="/page1" class="btn btn-primary w-100">ìƒì„¸ ë³´ê¸° â†’</a>
                    </div>
                </div>
            </div>

            <!-- í˜ì´ì§€ 2: ëŒ“ê¸€/ì¢‹ì•„ìš” -->
            <div class="col-md-6 col-lg-3 mb-4">
                <div class="card progress-card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">ğŸ’¬ í˜ì´ì§€ 2</h5>
                        <small>ëŒ“ê¸€/ì¢‹ì•„ìš”</small>
                    </div>
                    <div class="card-body">
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 0%;" id="page2Progress">0%</div>
                        </div>
                        <p class="card-text small">
                            <strong>ì£¼ìš” ê¸°ëŠ¥:</strong><br>
                            â€¢ ëŒ“ê¸€/ëŒ€ëŒ“ê¸€<br>
                            â€¢ ì¢‹ì•„ìš”<br>
                            â€¢ ë¶ë§ˆí¬<br>
                            â€¢ í†µê³„ ë™ê¸°í™”
                        </p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-secondary" id="page2Status">15ê°œ í…ŒìŠ¤íŠ¸</span>
                            <button class="btn btn-sm btn-outline-success" onclick="runPageTests(2)">í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
                        </div>
                    </div>
                    <div class="card-footer">
                        <a href="/page2" class="btn btn-success w-100">ìƒì„¸ ë³´ê¸° â†’</a>
                    </div>
                </div>
            </div>

            <!-- í˜ì´ì§€ 3: íŒŒì¼/ê²€ìƒ‰ -->
            <div class="col-md-6 col-lg-3 mb-4">
                <div class="card progress-card h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">ğŸ“ í˜ì´ì§€ 3</h5>
                        <small>íŒŒì¼/ê²€ìƒ‰</small>
                    </div>
                    <div class="card-body">
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar bg-info" role="progressbar" style="width: 0%;" id="page3Progress">0%</div>
                        </div>
                        <p class="card-text small">
                            <strong>ì£¼ìš” ê¸°ëŠ¥:</strong><br>
                            â€¢ íŒŒì¼ ì—…ë¡œë“œ<br>
                            â€¢ ì¸ë„¤ì¼ ìƒì„±<br>
                            â€¢ í‚¤ì›Œë“œ ê²€ìƒ‰<br>
                            â€¢ íƒœê·¸ ê²€ìƒ‰
                        </p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-secondary" id="page3Status">15ê°œ í…ŒìŠ¤íŠ¸</span>
                            <button class="btn btn-sm btn-outline-info" onclick="runPageTests(3)">í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
                        </div>
                    </div>
                    <div class="card-footer">
                        <a href="/page3" class="btn btn-info w-100">ìƒì„¸ ë³´ê¸° â†’</a>
                    </div>
                </div>
            </div>

            <!-- í˜ì´ì§€ 4: ê´€ë¦¬ì/Q&A -->
            <div class="col-md-6 col-lg-3 mb-4">
                <div class="card progress-card h-100">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">âš™ï¸ í˜ì´ì§€ 4</h5>
                        <small>ê´€ë¦¬ì/Q&A</small>
                    </div>
                    <div class="card-body">
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: 0%;" id="page4Progress">0%</div>
                        </div>
                        <p class="card-text small">
                            <strong>ì£¼ìš” ê¸°ëŠ¥:</strong><br>
                            â€¢ ì½˜í…ì¸  ê´€ë¦¬<br>
                            â€¢ ì‹ ê³  ì²˜ë¦¬<br>
                            â€¢ Q&A ì§ˆë¬¸/ë‹µë³€<br>
                            â€¢ í†µê³„
                        </p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-secondary" id="page4Status">15ê°œ í…ŒìŠ¤íŠ¸</span>
                            <button class="btn btn-sm btn-outline-warning" onclick="runPageTests(4)">í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
                        </div>
                    </div>
                    <div class="card-footer">
                        <a href="/page4" class="btn btn-warning w-100">ìƒì„¸ ë³´ê¸° â†’</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìµœê·¼ í…ŒìŠ¤íŠ¸ ê²°ê³¼ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ” ìµœê·¼ í…ŒìŠ¤íŠ¸ ê²°ê³¼</h5>
                    </div>
                    <div class="card-body" id="recentResults">
                        <p class="text-muted text-center">í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-5 py-3 bg-light">
        <div class="container text-center">
            <small class="text-muted">ê²Œì‹œíŒ ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬ í…ŒìŠ¤íŠ¸ ì›¹ì„œë¹„ìŠ¤ v1.0</small>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // í…ŒìŠ¤íŠ¸ ìƒíƒœ ë¡œë“œ
        async function loadTestStatus() {
            try {
                const response = await fetch('/api/test/status');
                const status = await response.json();
                updateDashboard(status);
            } catch (error) {
                console.error('í…ŒìŠ¤íŠ¸ ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        function updateDashboard(status) {
            document.getElementById('totalTests').textContent = status.totalTests;
            document.getElementById('passedTests').textContent = status.passedTests;
            document.getElementById('failedTests').textContent = status.failedTests;
            
            const overallRate = status.overallCompletionRate.toFixed(1);
            const overallProgress = document.getElementById('overallProgress');
            overallProgress.style.width = overallRate + '%';
            overallProgress.textContent = overallRate + '%';

            status.pageSummaries.forEach((page, index) => {
                const pageNum = index + 1;
                const rate = page.completionRate.toFixed(1);
                const progress = document.getElementById(`page${pageNum}Progress`);
                if (progress) {
                    progress.style.width = rate + '%';
                    progress.textContent = rate + '%';
                }
                const statusBadge = document.getElementById(`page${pageNum}Status`);
                if (statusBadge) {
                    statusBadge.textContent = `${page.passedTests}/${page.totalTests} í†µê³¼`;
                    statusBadge.className = page.passedTests === page.totalTests ? 'badge bg-success' : 'badge bg-secondary';
                }
            });
        }

        // í˜ì´ì§€ë³„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        async function runPageTests(pageNumber) {
            try {
                const response = await fetch(`/api/test/run/${pageNumber}`, { method: 'POST' });
                const results = await response.json();
                displayResults(results);
                loadTestStatus();
            } catch (error) {
                console.error('í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨:', error);
            }
        }

        // ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        async function runAllTests() {
            try {
                const response = await fetch('/api/test/run/all', { method: 'POST' });
                const status = await response.json();
                updateDashboard(status);
                
                // ëª¨ë“  ê²°ê³¼ í‘œì‹œ
                const allResults = status.pageSummaries.flatMap(p => p.testResults);
                displayResults(allResults);
            } catch (error) {
                console.error('ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨:', error);
            }
        }

        // ê²°ê³¼ í‘œì‹œ
        function displayResults(results) {
            const container = document.getElementById('recentResults');
            if (results.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const html = results.slice(0, 10).map(r => `
                <div class="test-item ${r.passed ? 'passed' : 'failed'}">
                    <div class="d-flex justify-content-between">
                        <strong>${r.testId}: ${r.testName}</strong>
                        <span class="badge ${r.passed ? 'bg-success' : 'bg-danger'}">${r.passed ? 'í†µê³¼' : 'ì‹¤íŒ¨'}</span>
                    </div>
                    <small class="text-muted">${r.details || ''}</small>
                    ${r.errorMessage ? `<br><small class="text-danger">${r.errorMessage}</small>` : ''}
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒíƒœ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', loadTestStatus);
    </script>
</body>
</html>
